# AI Storytelling System

A full-stack storytelling system designed for children ages 5-10, featuring a React-based chatbot frontend and a Python Flask backend with multiple AI agents.

## System Architecture

### Frontend (Port: 5173)
- React-based chatbot interface
- Modern UI with child-friendly design
- Real-time story interaction

### Backend (Port: 5001)
- Python Flask server
- Multiple AI agents:
  - Storyteller Agent: Generates age-appropriate stories
  - Judge Agent: Evaluates and improves story quality
  - Feedback Agent: Handles user interactions

### Features
- Age-appropriate storytelling (5-10 years)
- Story quality evaluation
- User feedback integration
- Story categorization
- RAG-based story enhancement

## Project Structure

The project is organized into the following main directories and files:

-   **`/.vscode/`**: Contains Visual Studio Code editor configurations, such as `launch.json` for debugging setups.
-   **`/backend/`**: Houses the Python Flask backend application.
    -   `agents/`: Core AI logic modules, including:
        -   `StorytellerAgent`: Generates stories.
        -   `IntentAnalyzer`: Classifies user prompts and extracts story elements.
        -   `JudgeAgent`: Evaluates story quality.
        -   `FeedbackAgent`: Processes evaluations to provide improvement feedback.
        -   `MemoryPersonalizationAgent`: Manages user profiles and preferences.
        -   `ConversationManager`: Handles conversation history.
        -   `StoryDatabase`: Manages data storage in JSON files.
        -   Other specialized agents (e.g., `CharacterEngineAgent`, `DialogueManagerAgent`).
    -   `app.py`: The main Flask application file. It defines API endpoints (like `/api/story`) and orchestrates agent interactions.
    -   `config.py`: Loads and provides configuration settings (e.g., API keys, server port, debug flags) from environment variables.
    -   `.env.example`: An example template for the `.env` file.
    -   `requirements.txt`: Lists Python package dependencies for the backend.
-   **`/database/`**: Stores application data persistently using JSON files. Each file typically represents a table or collection.
    -   `conversations.json`: Logs all interactions (messages) between users and the AI agent.
    -   `stories.json`: Stores the generated stories, including prompts and metadata.
    -   `user_profiles.json`: Contains user-specific information like age, preferences, and interaction history.
    -   `user_stories.json`: Links users to the stories they have interacted with, along with the intent.
    -   `story_evaluations.json`: Records the evaluations performed by the `JudgeAgent` on generated stories.
    -   `story_evaluation_feedback_log.json`: Logs the feedback generated by the `FeedbackAgent` based on story evaluations.
    -   `interactions.json`: Potentially logs other types of user interactions or serves as a general log.
-   **`/frontend/`**: Contains the React-based frontend application.
    -   `src/`: The source code for the React application.
        -   `App.jsx`: The main React component that structures the application's UI and handles state.
        -   `main.jsx`: The entry point for the React application, rendering the root component.
        -   Other components, styles (`index.css`), and configuration (`config.js`).
    -   `dist/` (output directory): Contains the bundled static assets for deployment (generated by Vite build process).
    -   `index.html`: The main HTML page that hosts the React application.
    -   `vite.config.js`: Configuration file for Vite, the frontend build tool and development server.
    -   `package.json`: Defines project metadata, scripts (e.g., `dev`, `build`), and frontend dependencies.
-   **`.env`**: (Not version controlled) Stores environment-specific variables like API keys and debug settings.
-   **`.gitattributes`**: A Git file to define attributes per path.
-   **`.gitignore`**: Specifies files and directories that Git should ignore.
-   **`LICENSE`**: Contains the MIT License under which the project is distributed.
-   **`README.md`**: This file, providing an overview and documentation for the project.

## Database Schema

The system uses JSON files stored in the `/database/` directory to persist data. Key "tables" include:

-   **`conversations.json`**: Array of conversation objects.
    -   `id` (int): Unique conversation identifier.
    -   `user_id` (str): User identifier.
    -   `timestamp` (str): ISO format timestamp of conversation creation.
    -   `messages` (array): List of message objects:
        -   `role` (str): "user" or "agent".
        -   `content` (str): The message text.
        -   `status` (str, optional for agent): e.g., "new_user_profiling_required", "proceed", "success".
    -   `last_updated` (str): ISO format timestamp of the last update.

-   **`stories.json`**: Array of story objects.
    -   `id` (int): Unique story identifier.
    -   `prompt` (str): The user prompt that led to the story.
    -   `story` (str): The generated story text.
    -   `timestamp` (str): ISO format timestamp of story creation.
    -   `metadata` (dict): Additional information like `length`, `complexity`, `theme`, `moral`.

-   **`user_profiles.json`**: A dictionary where keys are `user_id` (str) and values are profile objects.
    -   `user_id` (str): User's unique identifier.
    -   `age` (int/str, optional): User's age.
    -   `gender` (str, optional): User's gender.
    -   `created_at` (str): ISO format timestamp of profile creation.
    -   `last_interaction` (str): ISO format timestamp of the user's last interaction.
    -   `preferences` (dict): User's stated preferences (e.g., `favorite_characters`, `story_types`).
    -   `interaction_history` (list): Log of significant interactions.

-   **`user_stories.json`**: Array of objects linking users to stories.
    -   `id` (int): Unique identifier for this link.
    -   `user_id` (str): User identifier.
    -   `story_id` (int): Story identifier (links to `stories.json`).
    -   `prompt` (str): The specific prompt from the user for this story interaction.
    -   `intent` (str): The user's intent (e.g., "new_story", "change_story").
    -   `timestamp` (str): ISO format timestamp of this interaction.

-   **`story_evaluations.json`**: Array of evaluation objects.
    -   `id` (int): Unique evaluation identifier.
    -   `user_story_id` (int): Identifier linking to `user_stories.json` (or `story_id` directly).
    -   `evaluations` (dict): Detailed evaluation results (e.g., `is_appropriate`, `reason`, `score`, `feedback` text).
    -   `timestamp` (str): ISO format timestamp of the evaluation.

-   **`story_evaluation_feedback_log.json`**: Array of feedback log objects.
    -   Likely contains: `feedback_id`, `evaluation_id`, `feedback_message` (summarized feedback), `timestamp`.

-   **`interactions.json`**: Array of general interaction objects. Its specific structure might vary but generally logs user activities not covered by more specific files.

## Backend Workflows (`/backend/app.py`)

The primary workflow is handled by the `/api/story` endpoint:

1.  **Request Reception**: Accepts `POST` requests with a JSON payload containing `prompt` (user input) and an optional `user_id`.
2.  **User Identification & Profiling Logic**:
    -   Assigns a `user_id` if one is not provided or is "guest_user".
    -   Checks if the user is new or if prior interaction requires gathering profile information (e.g., age, preferences).
    -   If profiling is needed: The system responds by asking for preferences. This interaction is logged.
    -   If preferences are provided: The `MemoryPersonalizationAgent` updates the user's profile. The system confirms and prompts for a story. This is also logged.
3.  **Intent Analysis**:
    -   For regular story requests, the `IntentAnalyzer` processes the `prompt` along with conversation history and the last story (if applicable) to determine the user's `intent` (e.g., "new_story", "change_story", "ask_question") and extracts key `story_elements`.
    -   If the intent does not require story generation (e.g., a direct question), the system provides an appropriate message, logs it, and concludes the interaction.
4.  **Story Generation**: 
    -   If the intent is to create or modify a story, the `StorytellerAgent`'s `generate_story` method is invoked. 
    -   It uses the user's prompt, ID, extracted elements, intent, and any specific instructions to craft a detailed prompt for the OpenAI LLM (e.g., GPT-4).
    -   The LLM generates the story text.
    -   The new story and its link to the user are saved in `stories.json` and `user_stories.json` respectively, via the `StoryDatabase` agent.
5.  **Story Evaluation & Refinement Loop**:
    -   The generated story enters an iterative refinement loop (controlled by `EVALUATION_LIMIT` in `config.py`).
    -   The `JudgeAgent` evaluates the story based on criteria like age-appropriateness, coherence, and adherence to the prompt. The evaluation is saved.
    -   If the story's score is below a defined threshold (e.g., 7/10):
        -   The `FeedbackAgent` analyzes the evaluation and generates specific, actionable feedback for improvement. This feedback is logged.
        -   The `IntentAnalyzer` may update story elements based on this feedback.
        -   The `StorytellerAgent` attempts to `regenerate_story` using the original prompt, previous story, revised elements, and the feedback.
    -   The process repeats, and the story with the highest score from the iterations is selected as the final version.
6.  **Interaction Recording**: 
    -   Significant details of the interaction (e.g., prompt, a summary of the generated story) are recorded in the user's profile by the `MemoryPersonalizationAgent`.
7.  **Conversation Logging**: 
    -   The user's prompt and the final agent response (story or message) are appended to the ongoing conversation in `conversations.json` by the `ConversationManager`.
8.  **Response to Frontend**: 
    -   The final story (or message) along with a status (e.g., "success") is sent back to the frontend as a JSON response.

Additionally, the Flask app serves static files for the frontend from the `../frontend/dist` directory, enabling Single Page Application (SPA) routing.

## Tech Stack

-   **Frontend**:
    -   **Framework/Library**: React.js
    -   **UI Components**: Material UI (`@mui/material`)
    -   **Build Tool & Dev Server**: Vite
    -   **HTTP Client**: Axios (for API communication)
    -   **Language**: JavaScript (JSX)

-   **Backend**:
    -   **Framework**: Flask
    -   **Language**: Python
    -   **AI/LLM Integration**: OpenAI API (primarily GPT-4 model)
    -   **Environment Configuration**: `python-dotenv` (for managing `.env` files)
    -   **CORS**: `Flask-CORS`

-   **Database**:
    -   **Type**: File-based storage using JSON files.

-   **Version Control**:
    -   Git

-   **Development Environment**:
    -   **Editor**: Visual Studio Code (inferred from `.vscode` directory)
    -   **Configuration**: `.env` file for sensitive/environment-specific settings.

-   **License**:
    -   MIT License